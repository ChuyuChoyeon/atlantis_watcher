<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<meta name="theme-color" content="#ffffff">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
		<title>Atlantis Watcher</title>
		<script src="js/tailwindcss.js"></script>
		<style>
			/* 移动端优化 */
			body {
				-webkit-text-size-adjust: 100%;
				-webkit-tap-highlight-color: transparent;
				padding-bottom: 70px;
				/* 给底部导航留更多空间 */
				font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
				overflow-x: hidden; /* 防止水平溢出 */
				max-width: 100vw; /* 限制最大宽度 */
			}

			/* 手势滑动效果 */
			.swipe-container {
				width: 100%;
				overflow-x: hidden;
				touch-action: pan-y;
			}

			/* 触觉反馈 */
			button:active {
				transform: scale(0.96);
				transition: transform 0.1s;
			}

			/* 全屏查看优化 */
			#screenModal {
				transition: opacity 0.3s;
			}

			/* 全屏模式下的图片样式 */
			#screenModal:fullscreen #fullScreenView,
			#screenModal:-webkit-full-screen #fullScreenView,
			#screenModal:-moz-full-screen #fullScreenView {
				width: 100vw;
				height: 100vh;
				object-fit: contain;
				max-width: none;
				max-height: none;
				transform: none;
			}

			/* 进程管理表格手机端优化 */
			@media (max-width: 640px) {
				/* 进程表格紧凑布局 */
				#process-list tr {
					line-height: 1.2;
				}
				
				/* 进程名称列允许换行 */
				#process-list td:nth-child(1) {
					word-break: break-all;
					white-space: normal;
					min-width: 100px;
					max-width: 150px;
				}
				
				/* 状态标签更小 */
				#process-list .status-badge {
					padding: 2px 6px;
					font-size: 10px;
				}
				
				/* 操作按钮更紧凑 */
				#process-list .kill-btn {
					padding: 4px 8px;
					font-size: 11px;
					border-radius: 6px;
					min-width: 50px;
				}
			}

			/* 移动端全屏优化 */
			@media (max-width: 768px) {
				#screenModal {
					position: fixed;
					top: 0;
					left: 0;
					width: 100vw;
					height: 100vh;
					z-index: 9999;
				}
				
				#fullScreenView {
					width: 100vw;
					height: 100vh;
					object-fit: contain;
					transform: none;
				}
			}

			/* 全屏模式下隐藏关闭按钮的容器 */
			#screenModal:fullscreen .absolute,
			#screenModal:-webkit-full-screen .absolute,
			#screenModal:-moz-full-screen .absolute {
				display: none;
			}

			/* 命令结果框 */
			.result-box {
				border: 1px solid #d1d5db;
				background-color: #f9fafb;
				color: #374151;
				font-family: monospace;
				white-space: pre-wrap;
				max-height: 40vh;
				overflow-y: auto;
				font-size: 14px;
				line-height: 1.4;
			}
			
			.dark .result-box {
				border: 1px solid #374151;
				background-color: #1f2937;
				color: #e5e7eb;
			}

			/* 导航栏样式 */
			.nav-item {
				transition: all 0.3s ease;
				border-radius: 12px;
			}

			.nav-item:hover {
				transform: translateY(-1px);
			}

			.nav-item.active {
				color: #3b82f6;
			}

			.nav-item.active .w-8 {
				background-color: #dbeafe;
				color: #3b82f6;
			}

			.nav-item:not(.active) .w-8 {
				background-color: #f3f4f6;
				color: #6b7280;
				transition: all 0.3s ease;
			}
			
			.dark .nav-item:not(.active) .w-8 {
				background-color: #374151;
				color: #9ca3af;
			}

			.nav-item:not(.active):hover .w-8 {
				background-color: #e5e7eb;
			}
			
			.dark .nav-item:not(.active):hover .w-8 {
				background-color: #4b5563;
			}



			.btn-hover:hover {
				transform: translateY(-1px);
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
				/* 更柔和的阴影 */
			}
			
			.dark .btn-hover:hover {
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
			}

			/* 触摸反馈优化 */
			.btn-active:active {
				transform: translateY(1px);
				opacity: 0.9;
			}

			/* 卡片样式优化 */
			.card {
				border-radius: 16px;
				box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
				user-select: none;
				padding: 20px;
				margin-bottom: 16px;
				background: #ffffff;
				border: 1px solid rgba(0, 0, 0, 0.05);
				transition: all 0.3s ease;
			}

			.dark .card {
				background: #1f2937;
				border: 1px solid rgba(255, 255, 255, 0.1);
				box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
			}

			.card:hover {
				transform: translateY(-2px);
				box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
			}
			
			.dark .card:hover {
				box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
			}

			/* 移动端按钮优化 */
			button {
				min-width: 48px;
				min-height: 48px;
				border-radius: 12px;
				font-weight: 500;
				transition: all 0.2s ease;
				border: none;
				cursor: pointer;
			}

			/* 监控页面专用样式 */
			.monitor-grid {
				display: grid;
				gap: 1.5rem;
				grid-template-columns: 1fr;
			}

			@media (min-width: 768px) {
				.monitor-grid {
					grid-template-columns: repeat(2, 1fr);
				}
			}

			@media (min-width: 1024px) {
				.monitor-grid {
					grid-template-columns: repeat(2, 1fr);
					max-width: 1200px;
				}
			}

			/* 加载状态样式 */
			.loading {
				opacity: 0.6;
				pointer-events: none;
			}

			.loading::after {
				content: '';
				position: absolute;
				top: 50%;
				left: 50%;
				width: 20px;
				height: 20px;
				margin: -10px 0 0 -10px;
				border: 2px solid #f3f3f3;
				border-top: 2px solid #3498db;
				border-radius: 50%;
				animation: spin 1s linear infinite;
			}
			
			.dark .loading::after {
				border: 2px solid #374151;
				border-top: 2px solid #60a5fa;
			}

			@keyframes spin {
				0% { transform: rotate(0deg); }
				100% { transform: rotate(360deg); }
			}

			/* 错误状态样式 */
			.error-state {
				background: linear-gradient(135deg, #fee2e2, #fecaca);
				border-color: #f87171;
				color: #dc2626;
			}
			
			.dark .error-state {
				background: linear-gradient(135deg, #7f1d1d, #991b1b);
				border-color: #dc2626;
				color: #fca5a5;
			}



			


			button:active {
				transform: scale(0.95);
			}

			/* 对话框响应式优化 */


			/* 输入框移动端优化 */
			input[type="text"],
			input[type="number"] {
				font-size: 16px;
				/* 避免iOS缩放 */
				padding: 12px;
			}

			/* 自定义弹窗动画 */
			.fade-in {
				animation: fadeIn 0.3s ease-out;
			}

			@keyframes fadeIn {
				from {
					opacity: 0;
				}

				to {
					opacity: 1;
				}
			}

			/* 屏幕预览区域优化 */
			.screen-container {
				position: relative;
				width: 100%;
				aspect-ratio: 16/9; /* 固定宽高比 */
				min-height: 200px;
				max-height: 300px;
				border-radius: 8px;
				overflow: hidden;
				background: #f3f4f6;
			}

			#screenPreview {
				width: 100%;
				height: 100%;
				object-fit: cover;
				border-radius: 8px;
				transition: all 0.3s ease;
			}

			/* 未连接状态的占位图片样式 */
			#screenPreview[src*="data:image/png;base64"] {
				object-fit: cover;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				filter: none;
			}

			/* 加载动画 */
			@keyframes pulse {
				0% { opacity: 0.6; }
				50% { opacity: 1; }
				100% { opacity: 0.6; }
			}

			.loading {
				animation: pulse 1.5s infinite ease-in-out;
			}
			
			/* 无信号图标 */
			.no-signal-icon {
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				width: 64px;
				height: 64px;
				background-color: rgba(0, 0, 0, 0.5);
				border-radius: 50%;
				display: flex;
				justify-content: center;
				align-items: center;
			}
			
			.dark .no-signal-icon {
				background-color: rgba(255, 255, 255, 0.2);
			}
		</style>
	</head>
	<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
		<!-- 顶部状态栏 -->
		<div class="fixed top-0 left-0 right-0 bg-white dark:bg-gray-800 shadow-lg z-20 px-4 py-3 flex justify-between items-center backdrop-blur-md bg-white/95 dark:bg-gray-800/95">
			<h1 class="text-xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">Atlantis Watcher</h1>
			<div class="flex items-center gap-3">
				<button id="theme-toggle" onclick="toggleTheme()" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 transition-colors flex items-center justify-center">
					<svg id="theme-icon" class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
					</svg>
				</button>
				
			</div>
		</div>

		<div class="mt-16"></div> <!-- 为顶部状态栏留出更多空间 -->

		<!-- 功能分区 -->
		<div id="home-section" class="pb-16">
			<!-- IP配置区域 -->
			<div class="p-4 bg-white dark:bg-gray-800 rounded-lg shadow-sm mb-4 card">
				<label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">服务器IP</label>
				<div class="flex gap-2">
					<input type="text" id="ipInput" class="flex-1 p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" placeholder="192.168.1.100">
					<button onclick="saveIp()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 rounded transition-colors">保存</button>
				</div>
			</div>

			<!-- 屏幕预览 -->
			<div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-4 card">
				
				<div class="flex justify-between items-center mb-2">
					<h2 class="font-semibold text-gray-900 dark:text-gray-100">实时屏幕</h2>
					<div class="flex gap-2">
						
						<button onclick="toggleConnection()" id="connectBtn"
							class="bg-blue-500 text-white px-3 py-1 rounded text-sm flex items-center">
							<svg id="connectIcon" class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
							</svg>
							<span id="connectText">连接</span>
						</button>
						<button onclick="closeBtn()" id="closeBtn"
							class="bg-red-500 text-white px-3 py-1 rounded text-sm flex items-center">
							<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
							</svg>
							关闭
						</button>
					</div>
				</div>
				<div class="relative swipe-container screen-container">
					<img id="screenPreview" class=""
						src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAYdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjAuMTZEaa/1AAAADUlEQVQYV2P4//8/AwAI/AL+5Lh0lAAAAABJRU5ErkJggg=="
						alt="屏幕预览">
					<button id="fullscreenBtn"
						class="absolute bottom-4 right-4 bg-black bg-opacity-50 text-white p-2 rounded-full">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
							stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
								d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
						</svg>
						<span class="sr-only">横屏全屏查看</span>
					</button>
					<div id="screen-status" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 text-white hidden">
						<span id="status-text">连接中...</span>
						<div id="no-signal-icon" class="no-signal-icon hidden">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
							</svg>
						</div>
					</div>
				</div>

			</div>
			<!-- 全屏弹窗（原有结构增强） -->
			<div id="screenModal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-90 fade-in">
				<div class="absolute top-4 right-4">
					<button id="closeModal" class="text-white hover:text-gray-300 text-4xl">
						&times;
					</button>
				</div>
				<div class="flex items-center justify-center h-full">
				<img id="fullScreenView" class="w-full h-full object-contain" />
			</div>
			</div>

		</div>

		<!-- 快捷操作分区 -->
		<div id="quick-actions-section" class="hidden pb-16 p-4">


			<div class="grid grid-cols-2 gap-3 pt-2">
				<!-- 电源控制 -->

				<button onclick="showConfirmDialog('确认关机', '确定要立即关机吗？', () => executeCommand('shutdown'))"
					class="bg-red-100 dark:bg-red-900/30 hover:bg-red-200 dark:hover:bg-red-900/50 rounded-lg p-4 flex flex-col items-center transition-colors">
					<svg class="w-8 h-8 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
							d="M20.618 5.984A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016zM12 9v2m0 4h.01" />
					</svg>
					<span class="mt-2 text-sm text-gray-700 dark:text-gray-300">关机</span>
				</button>

				<!-- 重启 -->
				<button onclick="showConfirmDialog('确认重启', '确定要立即重启吗？', () => executeCommand('reboot'))"
					class="bg-purple-100 dark:bg-purple-900/30 hover:bg-purple-200 dark:hover:bg-purple-900/50 rounded-lg p-4 flex flex-col items-center transition-colors">
					<svg class="w-8 h-8 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
							d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
					</svg>
					<span class="mt-2 text-sm text-gray-700 dark:text-gray-300">重启</span>
				</button>

				<!-- 重启服务 -->
				<button onclick="showConfirmDialog('确认重启服务', '确定要重启服务吗？', () => restartService())"
					class="bg-green-100 dark:bg-green-900/30 hover:bg-green-200 dark:hover:bg-green-900/50 rounded-lg p-4 flex flex-col items-center transition-colors">
					<svg class="w-8 h-8 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
							d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
					</svg>
					<span class="mt-2 text-sm text-gray-700 dark:text-gray-300">重启服务</span>
				</button>


				<!-- 定时关机 -->
				<button onclick="showShutdownDialog()" class="bg-yellow-100 dark:bg-yellow-900/30 hover:bg-yellow-200 dark:hover:bg-yellow-900/50 rounded-lg p-4 flex flex-col items-center transition-colors">
					<svg class="w-8 h-8 text-yellow-600 dark:text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
							d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
					</svg>
					<span class="mt-2 text-sm text-gray-700 dark:text-gray-300">定时关机</span>
				</button>

				<!-- 取消关机 -->
				<button onclick="showConfirmDialog('确认取消关机', '确定要取消关机吗？', () => executeCommand('cancel'))"
					class="bg-green-100 dark:bg-green-900/30 hover:bg-green-200 dark:hover:bg-green-900/50 rounded-lg p-4 flex flex-col items-center transition-colors">
					<svg class="w-8 h-8 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
					</svg>
					<span class="mt-2 text-sm text-gray-700 dark:text-gray-300">取消关机</span>
				</button>

				<!-- 锁屏 -->
				<button onclick="showConfirmDialog('确认锁屏', '确定要锁定屏幕吗？', () => executeCommand('lock'))" class="bg-blue-100 dark:bg-blue-900/30 hover:bg-blue-200 dark:hover:bg-blue-900/50 rounded-lg p-4 flex flex-col items-center transition-colors">
					<svg class="w-8 h-8 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
							d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
					</svg>
					<span class="mt-2 text-sm text-gray-700 dark:text-gray-300">锁屏</span>
				</button>

				<!-- 注销 -->
				<button onclick="showConfirmDialog('确认注销', '确定要注销当前用户吗？', () => executeCommand('logout'))"
					class="bg-blue-200 dark:bg-blue-900/40 hover:bg-blue-300 dark:hover:bg-blue-900/60 rounded-lg p-4 flex flex-col items-center transition-colors">
					<svg class="w-8 h-8 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
							d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
					</svg>
					<span class="mt-2 text-sm text-gray-700 dark:text-gray-300">注销</span>
				</button>

			</div>

			<!-- 定时关机对话框 -->
			
			<div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg" id="resultBox">
				<p class="text-green-600 dark:text-green-400">等待执行命令...</p>
			</div>

		</div>

		<!-- 系统监控分区 -->
		<div id="monitor-section" class="hidden pb-16 p-6">

			
			<!-- 实时监控卡片 -->
			<div class="monitor-grid mx-auto mb-8">
				<!-- CPU监控 -->
				<div class="card bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/30 dark:to-blue-800/30 border-blue-200 dark:border-blue-700 min-h-[140px]">
					<div class="flex items-center justify-between mb-3">
						<h3 class="text-lg font-semibold text-blue-800 dark:text-blue-300 flex items-center">
							<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
							</svg>
							CPU使用率
						</h3>
						<span id="cpu-percent" class="text-2xl font-bold text-blue-600 dark:text-blue-400">0%</span>
					</div>
					<div class="w-full bg-blue-200 dark:bg-blue-800/50 rounded-full h-3">
						<div id="cpu-bar" class="bg-blue-600 dark:bg-blue-400 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
					</div>
				</div>

				<!-- 内存监控 -->
				<div class="card bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/30 dark:to-green-800/30 border-green-200 dark:border-green-700 min-h-[140px]">
					<div class="flex items-center justify-between mb-3">
						<h3 class="text-lg font-semibold text-green-800 dark:text-green-300 flex items-center">
							<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"/>
							</svg>
							内存使用率
						</h3>
						<span id="memory-percent" class="text-2xl font-bold text-green-600 dark:text-green-400">0%</span>
					</div>
					<div class="w-full bg-green-200 dark:bg-green-800/50 rounded-full h-3 mb-2">
						<div id="memory-bar" class="bg-green-600 dark:bg-green-400 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
					</div>
					<div class="text-sm text-green-700 dark:text-green-300">
						<span id="memory-used">0 GB</span> / <span id="memory-total">0 GB</span>
					</div>
				</div>

				<!-- 网络监控 -->
				<div class="card bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/30 dark:to-purple-800/30 border-purple-200 dark:border-purple-700 min-h-[140px]">
					<div class="flex items-center justify-between mb-3">
						<h3 class="text-lg font-semibold text-purple-800 dark:text-purple-300 flex items-center">
							<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"/>
							</svg>
							网络流量
						</h3>
					</div>
					<div class="space-y-2">
						<div class="flex justify-between items-center">
							<span class="text-sm text-purple-700 dark:text-purple-300">↑ 上传:</span>
							<span id="upload-speed" class="text-sm font-semibold text-purple-600 dark:text-purple-400">0 KB/s</span>
						</div>
						<div class="flex justify-between items-center">
							<span class="text-sm text-purple-700 dark:text-purple-300">↓ 下载:</span>
							<span id="download-speed" class="text-sm font-semibold text-purple-600 dark:text-purple-400">0 KB/s</span>
						</div>
					</div>
				</div>

				<!-- 磁盘监控 -->
				<div class="card bg-gradient-to-br from-orange-50 to-orange-100 dark:from-orange-900/30 dark:to-orange-800/30 border-orange-200 dark:border-orange-700 min-h-[140px]">
					<div class="flex items-center justify-between mb-3">
						<h3 class="text-lg font-semibold text-orange-800 dark:text-orange-300 flex items-center">
							<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
							</svg>
							磁盘空间
						</h3>
						<button onclick="refreshDiskInfo()" class="text-orange-600 dark:text-orange-400 hover:text-orange-800 dark:hover:text-orange-300">
							<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
							</svg>
						</button>
					</div>
					<div id="disk-info" class="space-y-2">
						<!-- 磁盘信息将在这里动态加载 -->
					</div>
				</div>
			</div>

			<!-- 进程管理 -->
			<div class="card max-w-7xl mx-auto">
				<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 gap-3">
				<h3 class="text-lg sm:text-xl font-semibold text-gray-900 dark:text-gray-100 flex items-center">
					<svg class="w-5 h-5 sm:w-6 sm:h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
					</svg>
					进程管理
				</h3>
				<button onclick="refreshProcesses()" class="bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 text-white px-4 py-2 sm:px-6 sm:py-3 rounded-lg transition-colors font-medium text-sm sm:text-base">
					刷新进程
				</button>
			</div>

			<!-- 进程搜索 -->
			<div class="mb-4">
				<input type="text" id="process-search" placeholder="搜索进程名称..." 
					class="w-full p-3 sm:p-4 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-sm sm:text-base" oninput="filterProcesses()">
			</div>

				<!-- 进程列表 -->
				<div class="overflow-x-auto bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
					<table class="w-full text-sm">
						<thead>
							<tr class="bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
								<th class="text-left p-2 sm:p-4 font-semibold text-gray-700 dark:text-gray-300 text-xs sm:text-sm">进程名</th>
								<th class="text-left p-2 sm:p-4 font-semibold text-gray-700 dark:text-gray-300 text-xs sm:text-sm">CPU%</th>
								<th class="text-left p-2 sm:p-4 font-semibold text-gray-700 dark:text-gray-300 text-xs sm:text-sm">内存%</th>
								<th class="text-left p-2 sm:p-4 font-semibold text-gray-700 dark:text-gray-300 text-xs sm:text-sm">操作</th>
							</tr>
						</thead>
						<tbody id="process-list">
							<!-- 进程列表将在这里动态加载 -->
						</tbody>
					</table>
				</div>
			</div>
		</div>

		<!-- 终端分区 -->
		<div id="terminal-section" class="hidden pb-16 p-4">
			<div class="mb-4">
				<div class="flex gap-2 mb-2">
					<input type="text" id="commandInput" class="flex-1 p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" placeholder="输入命令">
					<button onclick="executeCustomCommand()" class="bg-gray-800 hover:bg-gray-900 dark:bg-gray-600 dark:hover:bg-gray-500 text-white px-4 rounded transition-colors">执行</button>
				</div>
				<div class="flex items-center mb-2">
					<input type="checkbox" id="powershellCheckbox" class="mr-2">
					<label class="text-sm text-gray-700 dark:text-gray-300">PowerShell命令</label>
				</div>

				<!-- 常用命令快捷栏 -->
				<div class="mb-4">
					<h3 class="text-sm font-medium mb-2 text-gray-900 dark:text-gray-100">常用命令</h3>
					<div class="flex flex-wrap gap-2">
						<!-- 系统信息类 -->
						<button onclick="executeCustomCommand('ipconfig /all', false)"
							class="text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">网络配置</button>
						<button onclick="executeCustomCommand('systeminfo', false)"
							class="text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">系统信息</button>
						<button onclick="executeCustomCommand('dxdiag', false)"
							class="text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">硬件诊断</button>

						<!-- 文件管理类 -->
						<button onclick="executeCustomCommand('dir /s', false)"
							class="text-xs bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 px-3 py-1 rounded-full hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-colors">递归目录</button>
						<button onclick="executeCustomCommand('ls ~', true)"
							class="text-xs bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 px-3 py-1 rounded-full hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-colors">查看主文件夹</button>
						<!-- PowerShell专属 -->
						<button onclick="executeCustomCommand('Get-Process | Sort-Object CPU -Descending', true)"
							class="text-xs bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 px-3 py-1 rounded-full hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-colors">CPU进程排序</button>
						<button onclick="executeCustomCommand('Get-Service',true)"
							class="text-xs bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 px-3 py-1 rounded-full hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-colors">查看服务</button>

						<!-- 网络工具类 -->
						<button onclick="executeCustomCommand('netstat -ano', false)"
							class="text-xs bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 px-3 py-1 rounded-full hover:bg-green-200 dark:hover:bg-green-900/50 transition-colors">端口监控</button>
						<button onclick="executeCustomCommand('nslookup localhost', false)"
							class="text-xs bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 px-3 py-1 rounded-full hover:bg-green-200 dark:hover:bg-green-900/50 transition-colors">DNS查询</button>
						<button onclick="executeCustomCommand('arp -a', false)"
							class="text-xs bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 px-3 py-1 rounded-full hover:bg-green-200 dark:hover:bg-green-900/50 transition-colors">ARP缓存</button>
						<button onclick="executeCustomCommand('ping www.qq.com', false)"
							class="text-xs bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 px-3 py-1 rounded-full hover:bg-green-200 dark:hover:bg-green-900/50 transition-colors">网络连通</button>
						<button onclick="executeCustomCommand('tracert www.qq.com', false)"
							class="text-xs bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 px-3 py-1 rounded-full hover:bg-green-200 dark:hover:bg-green-900/50 transition-colors">路由追踪</button>

						<!-- 系统维护类 -->
					<button onclick="executeCustomCommand('chkdsk /f', false)"
						class="text-xs bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 px-3 py-1 rounded-full hover:bg-purple-200 dark:hover:bg-purple-900/50 transition-colors">磁盘修复</button>
					<button onclick="executeCustomCommand('defrag C: /o', false)"
						class="text-xs bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 px-3 py-1 rounded-full hover:bg-purple-200 dark:hover:bg-purple-900/50 transition-colors">优化磁盘</button>
					<button onclick="executeCustomCommand('dism /online /cleanup-image /restorehealth', false)"
						class="text-xs bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 px-3 py-1 rounded-full hover:bg-purple-200 dark:hover:bg-purple-900/50 transition-colors">系统修复</button>

					<!-- PowerShell专属 -->
					<button onclick="executeCustomCommand('Get-EventLog -LogName System -Newest 20', true)"
						class="text-xs bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 px-3 py-1 rounded-full hover:bg-orange-200 dark:hover:bg-orange-900/50 transition-colors">系统日志</button>
					<button
						onclick="executeCustomCommand('Get-WmiObject Win32_Processor | Select-Object Name,LoadPercentage', true)"
						class="text-xs bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 px-3 py-1 rounded-full hover:bg-orange-200 dark:hover:bg-orange-900/50 transition-colors">CPU负载</button>
					<button
						onclick="executeCustomCommand('Get-Disk | Select-Object Number,Size,HealthStatus', true)"
						class="text-xs bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 px-3 py-1 rounded-full hover:bg-orange-200 dark:hover:bg-orange-900/50 transition-colors">磁盘状态</button>
					</div>
				</div>
				<!-- 命令结果 -->
				<div class="result-box p-3  rounded-lg" id="cmdResultBox">
					<p class="text-gray-400 dark:text-gray-500">等待执行命令...</p>
				</div>


			</div>
		</div>

		<!-- 文件管理页面 -->
		<div id="files-section" class="hidden pb-16 p-4">
			<!-- 文件管理头部 -->
			<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm mb-4 p-4">
				<div class="flex items-center justify-between mb-3">
					<h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">文件管理</h2>
					<div class="flex gap-2">
						<button onclick="refreshFileList()" class="p-2 bg-blue-500 dark:bg-blue-600 text-white rounded-lg hover:bg-blue-600 dark:hover:bg-blue-700 transition-colors flex items-center justify-center">
				<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
				</svg>
			</button>
			<button onclick="goToParentDirectory()" class="p-2 bg-gray-500 dark:bg-gray-600 text-white rounded-lg hover:bg-gray-600 dark:hover:bg-gray-700 transition-colors flex items-center justify-center">
					<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
					</svg>
				</button>
					</div>
				</div>
				
				<!-- 当前路径显示 -->
				<div class="mb-3">
					<div class="text-sm text-gray-600 dark:text-gray-400 mb-1">当前路径:</div>
					<div id="current-path" class="bg-gray-100 dark:bg-gray-700 p-2 rounded text-sm font-mono break-all cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-900 dark:text-gray-100" onclick="showPathNavigation()">加载中...</div>
				</div>
				
				<!-- 操作按钮 -->
				<div class="flex gap-2 flex-wrap">
					<button onclick="showCreateDialog()" class="px-3 py-1 bg-green-500 dark:bg-green-600 text-white rounded text-sm hover:bg-green-600 dark:hover:bg-green-700 transition-colors">
						<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
						</svg>
						新建
					</button>
					<button onclick="showUploadDialog()" class="px-3 py-1 bg-blue-500 dark:bg-blue-600 text-white rounded text-sm hover:bg-blue-600 dark:hover:bg-blue-700 transition-colors">
						<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
						</svg>
						上传
					</button>
					<button id="paste-btn" onclick="pasteFiles()" class="px-3 py-1 bg-orange-500 dark:bg-orange-600 text-white rounded text-sm hover:bg-orange-600 dark:hover:bg-orange-700 transition-colors hidden">
						<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
						</svg>
						粘贴
					</button>
				</div>
			</div>
			
			<!-- 文件列表 -->
			<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm">
				<div id="file-list" class="divide-y divide-gray-200 dark:divide-gray-700">
					<div class="p-4 text-center text-gray-500 dark:text-gray-400">
						<div class="animate-spin w-6 h-6 border-2 border-blue-500 dark:border-blue-400 border-t-transparent rounded-full mx-auto mb-2"></div>
						加载中...
					</div>
				</div>
			</div>
		</div>

		<!-- 底部导航栏 -->
		<div class="fixed bottom-0 left-0 right-0 bg-white/95 dark:bg-gray-800/95 backdrop-blur-md shadow-2xl border-t border-gray-100 dark:border-gray-700 z-20">
			<div class="flex justify-around py-2 px-4">
				<button id="nav-home" onclick="showSection('home')" class="flex flex-col items-center text-blue-600 dark:text-blue-400 nav-item active min-w-0 flex-1 py-2">
					<div class="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center mb-1">
						<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
								d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
						</svg>
					</div>
					<span class="text-xs font-medium">首页</span>
				</button>

				<button id="nav-quick-actions" onclick="showSection('quick-actions')" class="flex flex-col items-center text-gray-500 dark:text-gray-400 nav-item min-w-0 flex-1 py-2">
					<div class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center mb-1">
						<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
								d="M13 10V3L4 14h7v7l9-11h-7z" />
						</svg>
					</div>
					<span class="text-xs font-medium">快捷操作</span>
				</button>

				<button id="nav-monitor" onclick="showSection('monitor')" class="flex flex-col items-center text-gray-500 dark:text-gray-400 nav-item min-w-0 flex-1 py-2">
					<div class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center mb-1">
						<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
								d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
						</svg>
					</div>
					<span class="text-xs font-medium">监控</span>
				</button>

				<button id="nav-files" onclick="showSection('files')" class="flex flex-col items-center text-gray-500 dark:text-gray-400 nav-item min-w-0 flex-1 py-2">
					<div class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center mb-1">
						<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
								d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-5l-2-2H5a2 2 0 00-2 2z" />
						</svg>
					</div>
					<span class="text-xs font-medium">文件</span>
				</button>

				<button id="nav-terminal" onclick="showSection('terminal')" class="flex flex-col items-center text-gray-500 dark:text-gray-400 nav-item min-w-0 flex-1 py-2">
					<div class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center mb-1">
						<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
								d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
						</svg>
					</div>
					<span class="text-xs font-medium">终端</span>
				</button>
			</div>

		</div>


		<script>
			// 全局配置
			const STORAGE_KEY = 'saved_ip';
			let baseUrl = `http://${localStorage.getItem(STORAGE_KEY) || '192.168.1.100'}:8988`;
			let socket;
			let reconnectAttempts = 0;
			const MAX_RECONNECT_ATTEMPTS = 5;
			let reconnectTimer = null;
			let heartbeatInterval = null;
			let autoReconnect = true; // 控制是否自动重连

			// 保存IP地址
			function saveIp() {
				const ip = document.getElementById('ipInput').value.trim();
				if (!/^(\d{1,3}\.){3}\d{1,3}$/.test(ip)) {
					showDialog('错误', '请输入有效的IP地址');
					return;
				}

				localStorage.setItem(STORAGE_KEY, ip);
				baseUrl = `http://${ip}:8988`;
				
				// 显示保存成功提示
				showToast('IP已保存');

				// 重新连接WebSocket
				if (socket) socket.close();
				
				// 显示连接中状态
				document.getElementById('screen-status').classList.remove('hidden');
				document.getElementById('screen-status').innerHTML = '<span>正在连接新IP...</span>';

				
				setTimeout(() => {
					initWebSocket();
				}, 300);
			}


			// 初始化函数
			function init() {
				// 加载保存的IP
				const savedIp = localStorage.getItem(STORAGE_KEY);
				if (savedIp) {
					document.getElementById('ipInput').value = savedIp;
				}

				// 更新连接状态显示为未连接


				// 不自动连接WebSocket，等待用户手动连接
				// initWebSocket();

				// 添加手势滑动支持
				setupSwipeGestures();
				
				// 添加页面可见性变化监听
				document.addEventListener('visibilitychange', handleVisibilityChange);
			}

			// WebSocket初始化
			function initWebSocket() {
				try {
					// 清除之前的心跳检测
					if (heartbeatInterval) {
						clearInterval(heartbeatInterval);
						heartbeatInterval = null;
					}
					
					const wsIp = localStorage.getItem(STORAGE_KEY) || '192.168.1.100';
					socket = new WebSocket(`ws://${wsIp}:8988/ws/screen`);

					// 显示连接中状态
					const screenPreview = document.getElementById('screenPreview');
					const screenStatus = document.getElementById('screen-status');
					const statusText = document.getElementById('status-text');
					const noSignalIcon = document.getElementById('no-signal-icon');
					
					if (screenPreview) screenPreview.classList.add('loading');
					if (screenStatus) screenStatus.classList.remove('hidden');
					if (statusText) statusText.textContent = '连接中...';
					if (noSignalIcon) noSignalIcon.classList.add('hidden');

					// 设置连接超时
					const connectionTimeout = setTimeout(() => {
						if (socket.readyState !== WebSocket.OPEN) {
							console.log('WebSocket连接超时');
							socket.close();
			
							const statusText = document.getElementById('status-text');
							const noSignalIcon = document.getElementById('no-signal-icon');
							if (statusText) statusText.textContent = '连接超时';
							if (noSignalIcon) noSignalIcon.classList.remove('hidden');
						}
					}, 5000);

					socket.onopen = () => {
						console.log('WebSocket连接已建立');
						clearTimeout(connectionTimeout);
						document.getElementById('screenPreview').classList.remove('loading');
						document.getElementById('screen-status').classList.add('hidden');
		
						// 重置重连计数
						reconnectAttempts = 0;
						// 清除任何待处理的重连计时器
						if (reconnectTimer) {
							clearTimeout(reconnectTimer);
							reconnectTimer = null;
						}
						
						// 设置心跳检测，每30秒发送一次心跳
						heartbeatInterval = setInterval(() => {
							if (socket.readyState === WebSocket.OPEN) {
								// 发送心跳包
								try {
									// 发送ping消息
									socket.send('ping');
									console.log('心跳检测已发送');
									
									// 设置超时检测，如果5秒内没有收到pong响应，认为连接已断开
									const pongTimeout = setTimeout(() => {
										console.error('心跳响应超时，连接可能已断开');
										// 如果连接仍然是打开状态，手动关闭它
										if (socket.readyState === WebSocket.OPEN) {
											socket.close();
										}
									}, 5000);
									
									// 存储超时检测器，以便在收到pong时清除
									socket.pongTimeoutId = pongTimeout;
								} catch (e) {
									console.error('心跳发送失败:', e);
									socket.close();
								}
							}
						}, 30000);
					};

					socket.onmessage = (event) => {
						// 检查是否是文本消息（心跳响应）
						if (typeof event.data === 'string') {
							if (event.data === 'pong') {
								console.log('收到心跳响应');
								// 清除pong超时检测
								if (socket.pongTimeoutId) {
									clearTimeout(socket.pongTimeoutId);
									socket.pongTimeoutId = null;
								}
								// 更新最后接收消息的时间戳
								socket.lastMessageTime = Date.now();
								return;
							}
						}
						
						// 处理二进制消息（屏幕截图）
						const blob = new Blob([event.data], {
							type: 'image/jpeg'
						});
						const url = URL.createObjectURL(blob);
						const screenPreview = document.getElementById('screenPreview');
						const fullScreenView = document.getElementById('fullScreenView');
						const screenStatus = document.getElementById('screen-status');
						
						if (screenPreview) {
							screenPreview.src = url;
							screenPreview.classList.remove('loading');
						}
						if (fullScreenView) fullScreenView.src = url;
						if (screenStatus) screenStatus.classList.add('hidden');
						// 更新最后接收消息的时间戳
						socket.lastMessageTime = Date.now();
					};

					socket.onerror = (error) => {
					console.error('WebSocket错误:', error);
					clearTimeout(connectionTimeout);
					const screenPreview = document.getElementById('screenPreview');
					const screenStatus = document.getElementById('screen-status');
					const statusText = document.getElementById('status-text');
					const noSignalIcon = document.getElementById('no-signal-icon');
					
					if (screenPreview) screenPreview.classList.remove('loading');
					if (screenStatus) screenStatus.classList.remove('hidden');
					if (statusText) statusText.textContent = '连接错误';
					if (noSignalIcon) noSignalIcon.classList.remove('hidden');
	
				};

					socket.onclose = () => {
						console.log('WebSocket连接已关闭');
						clearTimeout(connectionTimeout);
						// 清除心跳检测
						if (heartbeatInterval) {
							clearInterval(heartbeatInterval);
							heartbeatInterval = null;
						}
						
						const screenPreview = document.getElementById('screenPreview');
					const screenStatus = document.getElementById('screen-status');
					const statusText = document.getElementById('status-text');
					const noSignalIcon = document.getElementById('no-signal-icon');
					
					if (screenPreview) screenPreview.classList.remove('loading');
					if (screenStatus) screenStatus.classList.remove('hidden');
					if (statusText) statusText.textContent = '连接已断开';
					if (noSignalIcon) noSignalIcon.classList.remove('hidden');
		
						
						// 只有在自动重连模式下才尝试重连
						if (autoReconnect) {
							tryReconnect();
						}
					};
				} catch (error) {
					console.error('WebSocket初始化错误:', error);
	
					const screenStatus = document.getElementById('screen-status');
					const statusText = document.getElementById('status-text');
					const noSignalIcon = document.getElementById('no-signal-icon');
					
					if (screenStatus) screenStatus.classList.remove('hidden');
					if (statusText) statusText.textContent = '连接失败';
					if (noSignalIcon) noSignalIcon.classList.remove('hidden');
				}
			}

			function closeBtn() {
				if (socket && socket.readyState === WebSocket.OPEN) {
					// 关闭连接前禁用自动重连
					autoReconnect = false;
					// 清除心跳检测
					if (heartbeatInterval) {
						clearInterval(heartbeatInterval);
						heartbeatInterval = null;
					}
					// 清除重连计时器
					if (reconnectTimer) {
						clearTimeout(reconnectTimer);
						reconnectTimer = null;
					}
					
					socket.close();
				const screenPreview = document.getElementById('screenPreview');
				const screenStatus = document.getElementById('screen-status');
				const statusText = document.getElementById('status-text');
				const noSignalIcon = document.getElementById('no-signal-icon');
				
				if (screenPreview) screenPreview.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAYdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjAuMTZEaa/1AAAADUlEQVQYV2P4//8/AwAI/AL+5Lh0lAAAAABJRU5ErkJggg==";
				if (screenStatus) screenStatus.classList.remove('hidden');
				if (statusText) statusText.textContent = '已手动断开';
				if (noSignalIcon) noSignalIcon.classList.remove('hidden');
					updateConnectionStatus('已断开');
				}
			}

			// 连接/刷新切换函数
			function toggleConnection() {
			const isConnected = socket && socket.readyState === WebSocket.OPEN;
			
			if (isConnected) {
				// 如果已连接，则刷新连接
				resBtn();
			} else {
				// 如果未连接，则开始连接
				// 启用自动重连
				autoReconnect = true;
				
				// 显示连接中状态
				const screenStatus = document.getElementById('screen-status');
				const statusText = document.getElementById('status-text');
				const noSignalIcon = document.getElementById('no-signal-icon');
				
				if (screenStatus) screenStatus.classList.remove('hidden');
				if (statusText) statusText.textContent = '正在连接...';
				if (noSignalIcon) noSignalIcon.classList.add('hidden');
				
				// 开始连接
				initWebSocket();
			}
		}
			

			
			// 刷新连接函数
			function resBtn() {
				// 启用自动重连
				autoReconnect = true;
				// 重新连接WebSocket
				if (socket) {
					if (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING) {
						// 清除心跳检测
						if (heartbeatInterval) {
							clearInterval(heartbeatInterval);
							heartbeatInterval = null;
						}
						// 清除重连计时器
						if (reconnectTimer) {
							clearTimeout(reconnectTimer);
							reconnectTimer = null;
						}
						socket.close();
					}
				}
				
				// 显示连接中状态
				const screenStatus = document.getElementById('screen-status');
				const statusText = document.getElementById('status-text');
				const noSignalIcon = document.getElementById('no-signal-icon');
				
				if (screenStatus) screenStatus.classList.remove('hidden');
				if (statusText) statusText.textContent = '正在重新连接...';
				if (noSignalIcon) noSignalIcon.classList.add('hidden');
				updateConnectionStatus('正在连接');
				
				// 添加延迟以确保前一个连接已完全关闭
				setTimeout(() => {
					initWebSocket();
				}, 300);
			}


			// 执行命令函数
			async function executeCommand(action) {
				const resultBox = document.getElementById('resultBox');
				resultBox.innerHTML = `<p class="text-green-600">$ ${action}\n执行中... </p>`;
				resultBox.scrollTop = 0; // 滚动到顶部

				try {
					// 显示加载状态
					showLoading(true);

					const response = await fetch(`${baseUrl}/${action}`, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({})
					});

					// 隐藏加载状态
					showLoading(false);

					let data;
					if (!response.ok) {
						// 尝试解析错误响应
						try {
							data = await response.json();
							if (data.detail) {
								// FastAPI错误格式
								resultBox.innerHTML = `<p class="text-red-500">$ ${action}\n错误: ${data.detail.error || data.detail}</p>`;
							} else {
								resultBox.innerHTML = `<p class="text-red-500">$ ${action}\n错误: ${data.error || '未知错误'}</p>`;
							}
						} catch (e) {
							resultBox.innerHTML = `<p class="text-red-500">$ ${action}\n错误: 服务器响应错误 ${response.status}</p>`;
						}
						showToast('命令执行失败', true);
						showLoading(false);
						return;
					}

					data = await response.json();
					resultBox.innerHTML = `<p class="text-green-600">$ ${action}\n${data.output || data.error || '操作成功'} </p>`;
					
					// 如果是关机或重启命令，显示提示
					if (action === 'shutdown' || action === 'reboot') {
						showToast(action === 'shutdown' ? '关机命令已发送' : '重启命令已发送');
					}
				} catch (error) {
				resultBox.innerHTML = `<p class="text-red-500">$ ${action}\n错误: ${error.message}</p>`;
				showToast('命令执行失败', true);
				showLoading(false);
			}
		}

		// 重启服务
		async function restartService() {
			const resultBox = document.getElementById('resultBox');
			resultBox.innerHTML = `<p class="text-green-600">$ restart-service\n正在重启服务... </p>`;
			resultBox.scrollTop = 0;

			try {
				showLoading(true);

				const response = await fetch(`${baseUrl}/api/system/restart`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({})
				});

				showLoading(false);

				if (!response.ok) {
					try {
						const data = await response.json();
						resultBox.innerHTML = `<p class="text-red-500">$ restart-service\n错误: ${data.detail || '重启失败'}</p>`;
					} catch (e) {
						resultBox.innerHTML = `<p class="text-red-500">$ restart-service\n错误: 服务器响应错误 ${response.status}</p>`;
					}
					showToast('服务重启失败', true);
					return;
				}

				const data = await response.json();
				resultBox.innerHTML = `<p class="text-green-600">$ restart-service\n${data.message || '服务重启中...'}</p>`;
				showToast('服务重启中，请稍候...');
				
				// 等待几秒后自动刷新页面
				setTimeout(() => {
					window.location.reload();
				}, 3000);
				
			} catch (error) {
				resultBox.innerHTML = `<p class="text-red-500">$ restart-service\n错误: ${error.message}</p>`;
				showToast('服务重启失败', true);
				showLoading(false);
			}
		}

			// 执行自定义命令

// 显示定时关机对话框
function showShutdownDialog() {
	const modal = document.createElement('div');
	modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
	modal.innerHTML = `
		<div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md">
			<h3 class="font-semibold mb-4 text-gray-900 dark:text-gray-100">定时关机设置</h3>
			<div class="mb-4">
				<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">关机时间（秒）:</label>
				<input type="number" id="shutdown-seconds-input" min="1" value="60" 
					class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" placeholder="秒数">
			</div>
			<div class="flex gap-2 justify-end">
				<button onclick="closeModal()" class="px-4 py-2 bg-gray-500 dark:bg-gray-600 text-white rounded hover:bg-gray-600 dark:hover:bg-gray-700 transition-colors">取消</button>
				<button onclick="confirmScheduleShutdown()" class="px-4 py-2 bg-yellow-500 dark:bg-yellow-600 text-white rounded hover:bg-yellow-600 dark:hover:bg-yellow-700 transition-colors">确认</button>
			</div>
		</div>
	`;
	document.body.appendChild(modal);
	window.currentModal = modal;
	
	// 聚焦到输入框
	setTimeout(() => {
		document.getElementById('shutdown-seconds-input').focus();
	}, 100);
}

// 关闭模态框
function closeModal() {
	if (window.currentModal) {
		document.body.removeChild(window.currentModal);
		window.currentModal = null;
	}
}

// 确认定时关机
async function confirmScheduleShutdown() {
	const seconds = document.getElementById('shutdown-seconds-input').value;
	if (seconds > 0) {
		await executeCommand(`shutdown/${seconds}`);
		closeModal();
	} else {
		showDialog('错误', '请输入有效的秒数');
	}
}

// 设置定时关机（保留原函数以兼容）
async function scheduleShutdown() {
	const seconds = document.getElementById('shutdownSeconds').value;
	if (seconds > 0) {
		await executeCommand(`shutdown/${seconds}`);
		document.getElementById('shutdownDialog').classList.add('hidden');
	} else {
		showDialog('错误', '请输入有效的秒数');
	}
}
async function executeCustomCommand(command = null, isPowerShell = false) {
	const cmd = command || document.getElementById('commandInput').value.trim();
	if (!cmd) return;

	const isPs = isPowerShell || document.getElementById('powershellCheckbox').checked;
	const cmdResultBox = document.getElementById('cmdResultBox');
	cmdResultBox.innerHTML = `$ ${isPs ? 'PS>' : ''} ${cmd}\n执行中...`;

	try {
		const response = await fetch(`${baseUrl}/cmd`, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify({
				command: cmd,
				is_powershell: isPs
			})
		});

		const data = await response.json();
		cmdResultBox.innerHTML = `$ ${isPs ? 'PS>' : ''} ${cmd}\n${data.output || data.error || '无输出'}`;
	} catch (error) {
		cmdResultBox.innerHTML = `$ ${isPs ? 'PS>' : ''} ${cmd}\n错误: ${error.message}`;
	}
}

// 现代化确认对话框
function showConfirmDialog(title, message, confirmText = '确认', cancelText = '取消') {
	return new Promise((resolve) => {
		// 创建对话框HTML
		const dialogHTML = `
			<div id="confirmDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
				<div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full mx-4 transform transition-all">
					<div class="p-6">
						<div class="flex items-center mb-4">
							<div class="w-12 h-12 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mr-4">
								<svg class="w-6 h-6 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
								</svg>
							</div>
							<h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">${title}</h3>
						</div>
						<p class="text-gray-600 dark:text-gray-300 mb-6 whitespace-pre-line">${message}</p>
						<div class="flex flex-col sm:flex-row gap-3 sm:justify-end">
							<button id="confirmCancel" class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg transition-colors font-medium">
								${cancelText}
							</button>
							<button id="confirmOk" class="px-4 py-2 bg-red-600 dark:bg-red-600 hover:bg-red-700 dark:hover:bg-red-700 text-white rounded-lg transition-colors font-medium">
								${confirmText}
							</button>
						</div>
					</div>
				</div>
			</div>
		`;
		
		// 添加到页面
		document.body.insertAdjacentHTML('beforeend', dialogHTML);
		const dialog = document.getElementById('confirmDialog');
		
		// 绑定事件
		document.getElementById('confirmOk').onclick = () => {
			dialog.remove();
			resolve(true);
		};
		
		document.getElementById('confirmCancel').onclick = () => {
			dialog.remove();
			resolve(false);
		};
		
		// 点击背景关闭
		dialog.onclick = (e) => {
			if (e.target === dialog) {
				dialog.remove();
				resolve(false);
			}
		};
		
		// ESC键关闭
		const handleEsc = (e) => {
			if (e.key === 'Escape') {
				dialog.remove();
				resolve(false);
				document.removeEventListener('keydown', handleEsc);
			}
		};
		document.addEventListener('keydown', handleEsc);
	});
}

			// 系统监控WebSocket连接
			const maxReconnectAttempts = 5;
			
			function connectMonitorWebSocket() {
				if (monitorSocket && monitorSocket.readyState === WebSocket.OPEN) {
					return;
				}

				// 监控WebSocket不影响主连接状态显示
				const wsIp = localStorage.getItem(STORAGE_KEY) || '192.168.1.100';
				monitorSocket = new WebSocket(`ws://${wsIp}:8988/ws/monitor`);

				monitorSocket.onopen = function() {
					console.log('系统监控WebSocket连接已建立');
					reconnectAttempts = 0;
					// 保持主连接状态不变
				};

				monitorSocket.onmessage = function(event) {
					try {
						if (event.data === 'pong') {
							return; // 心跳响应
						}
						const data = JSON.parse(event.data);
						updateMonitorDisplay(data);
					} catch (e) {
						console.error('解析监控数据失败:', e);
					}
				};

				monitorSocket.onclose = function() {
					console.log('系统监控WebSocket连接已关闭');
					// 不影响主连接状态显示
					
					// 自动重连
					if (reconnectAttempts < maxReconnectAttempts) {
						reconnectAttempts++;
						console.log(`尝试重连 (${reconnectAttempts}/${maxReconnectAttempts})`);
						setTimeout(() => {
							if (!document.getElementById('monitor-section').classList.contains('hidden')) {
								connectMonitorWebSocket();
							}
						}, 3000 * reconnectAttempts);
					} else {
						showToast('监控连接失败，请检查网络连接', true);
					}
				};

				monitorSocket.onerror = function(error) {
					console.error('系统监控WebSocket错误:', error);

				};
			}

			

			// 分区切换
			function showSection(sectionId) {
				// 更新页面显示
				['home', 'quick-actions', 'monitor', 'terminal', 'files'].forEach(id => {
					document.getElementById(`${id}-section`).classList.toggle('hidden', id !== sectionId);
				});

				// 如果切换到监控页面，启动相关功能
				if (sectionId === 'monitor') {
					connectMonitorWebSocket();
					refreshDiskInfo();
					refreshProcesses();
				} else {
					// 如果离开监控页面，关闭WebSocket连接
					if (monitorSocket && monitorSocket.readyState === WebSocket.OPEN) {
						monitorSocket.close();
					}
				}
				
				// 如果切换到文件管理页面，初始化文件管理器
				if (sectionId === 'files') {
					initFileManager();
				}

				// 更新导航栏选中状态
				document.querySelectorAll('.nav-item').forEach(item => {
					item.classList.remove('active');
					item.classList.add('text-gray-500', 'dark:text-gray-400');
					item.classList.remove('text-blue-600');
				});

				// 设置当前选中项
				const currentNav = document.getElementById(`nav-${sectionId}`);
				currentNav.classList.add('active');
				currentNav.classList.remove('text-gray-500', 'dark:text-gray-400');
				currentNav.classList.add('text-blue-600');

				// 更新当前页面记录（用于手势滑动）
				currentSection = sectionId;
			}

			// 设置手势滑动
			function setupSwipeGestures() {
				let touchStartX = 0;
				let currentSection = 'home'; // 默认页面

				document.addEventListener('touchstart', (e) => {
					touchStartX = e.changedTouches[0].screenX;
					touchStartY = e.changedTouches[0].screenY;
				});

				document.addEventListener('touchend', (e) => {
					const touchEndX = e.changedTouches[0].screenX;
					const touchEndY = e.changedTouches[0].screenY;
					const diffX = touchStartX - touchEndX;
					const diffY = touchStartY - touchEndY;

					// 检测是否为水平滑动（忽略小的移动和垂直滑动）
					if (Math.abs(diffX) < 50 || Math.abs(diffY) > Math.abs(diffX)) return;

					const sections = ['home', 'quick-actions', 'monitor', 'terminal'];
					const currentIndex = sections.indexOf(currentSection);

					if (diffX > 0) {
						// 向左滑动，显示下一个分区
						const nextIndex = Math.min(currentIndex + 1, sections.length - 1);
						currentSection = sections[nextIndex];
						showSection(currentSection);
					} else {
						// 向右滑动，显示上一个分区
						const prevIndex = Math.max(currentIndex - 1, 0);
						currentSection = sections[prevIndex];
						showSection(currentSection);
					}
				});
			}

			// 尝试重新连接WebSocket
			function tryReconnect() {
				// 如果自动重连被禁用，则不进行重连
				if (!autoReconnect) {
					console.log('自动重连已禁用，不进行重连');
					return;
				}
				
				if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
					console.log('达到最大重连次数，停止重连');
	
					// 显示无信号图标
					document.getElementById('no-signal-icon').classList.remove('hidden');
					return;
				}
				
				reconnectAttempts++;
				const delay = Math.min(1000 * Math.pow(2, reconnectAttempts - 1), 10000);
				
				console.log(`尝试第 ${reconnectAttempts} 次重连，延迟 ${delay}ms`);

				
				// 更新状态显示
				const statusText = document.getElementById('status-text');
				if (statusText) statusText.textContent = `重连中 (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})...`;
				
				reconnectTimer = setTimeout(() => {
					initWebSocket();
				}, delay);
			}

			// 处理页面可见性变化
			function handleVisibilityChange() {
				if (document.visibilityState === 'visible') {
					// 页面变为可见时，检查WebSocket连接状态
					if (!socket || socket.readyState === WebSocket.CLOSED || socket.readyState === WebSocket.CLOSING) {
						console.log('页面可见，重新连接WebSocket');
						// 只有在自动重连模式下才重新连接
						if (autoReconnect) {
							resBtn(); // 重新连接
						}
					} else if (socket.readyState === WebSocket.OPEN) {
						// 如果连接已经打开，检查最后一次接收消息的时间
						if (socket.lastMessageTime) {
							const now = Date.now();
							const elapsed = now - socket.lastMessageTime;
							// 如果超过60秒没有收到消息，重新连接
							if (elapsed > 60000 && autoReconnect) {
								console.log('长时间未收到消息，重新连接WebSocket');
								socket.close();
								// 重置重连计数
								reconnectAttempts = 0;
								// 初始化WebSocket
								initWebSocket();
							}
						}
					}
				}
			}

			// 显示加载状态
			function showLoading(show) {
				const loadingElement = document.getElementById('loading-overlay');
				if (!loadingElement) {
					// 如果不存在，创建加载覆盖层
					const overlay = document.createElement('div');
					overlay.id = 'loading-overlay';
					overlay.className = 'fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50';
					overlay.innerHTML = `
						<div class="bg-white p-4 rounded-lg shadow-lg flex items-center">
							<svg class="animate-spin h-5 w-5 mr-3 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
								<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
								<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
							</svg>
							<span>处理中...</span>
						</div>
					`;
					document.body.appendChild(overlay);
					overlay.style.display = show ? 'flex' : 'none';
				} else {
					loadingElement.style.display = show ? 'flex' : 'none';
				}
			}

			// 显示提示框
function showToast(message, isError = false) {
	// 移除现有的提示框
	const existingToast = document.getElementById('toast');
	if (existingToast) {
		existingToast.remove();
	}
	
	// 创建新的提示框
	const toast = document.createElement('div');
	toast.id = 'toast';
	toast.className = `fixed bottom-20 left-1/2 transform -translate-x-1/2 px-4 py-3 rounded-lg shadow-lg z-50 font-medium ${isError ? 'bg-red-500 dark:bg-red-600 text-white' : 'bg-green-500 dark:bg-green-600 text-white'} border ${isError ? 'border-red-600 dark:border-red-500' : 'border-green-600 dark:border-green-500'}`;
	toast.textContent = message;
	
	document.body.appendChild(toast);
	
	// 3秒后自动消失
	setTimeout(() => {
		toast.classList.add('opacity-0');
		toast.style.transition = 'opacity 0.5s ease';
		setTimeout(() => toast.remove(), 500);
	}, 3000);
}

			// 页面加载初始化
			window.addEventListener('DOMContentLoaded', init);
		</script>

		<script>
				// 元素获取
			const fullscreenBtn = document.getElementById('fullscreenBtn');
			const screenModal = document.getElementById('screenModal');
			const closeModalBtn = document.getElementById('closeModal');
			const screenPreview = document.getElementById('screenPreview');
			const fullScreenView = document.getElementById('fullScreenView');
			
			// 系统监控相关变量
			let monitorSocket = null;
			let allProcesses = [];
			let filteredProcesses = [];
			
			/* 真正的全屏模式 */
			fullscreenBtn.addEventListener('click', async () => {
				// 同步图片源到全屏视图
				fullScreenView.src = screenPreview.src;
				// 显示模态框
				screenModal.classList.remove('hidden');
				// 锁定页面滚动
				document.body.style.overflow = 'hidden';
				
				// 移动端屏幕方向优化
				if (screen.orientation && screen.orientation.lock) {
					try {
						// 尝试锁定为横屏（如果图片是横向的）
						await screen.orientation.lock('landscape');
					} catch (e) {
						// 如果锁定失败，继续正常流程
						console.log('屏幕方向锁定不支持或被拒绝');
					}
				}
				
				// 进入浏览器原生全屏模式
				setTimeout(() => {
					toggleNativeFullscreen(screenModal);
				}, 100);
			});

			/* 浏览器原生全屏模式 */
			function toggleNativeFullscreen(element = document.documentElement) {
				// 检测当前全屏状态
				if (document.fullscreenElement ||
					document.webkitFullscreenElement ||
					document.mozFullScreenElement ||
					document.msFullscreenElement) {
					// 退出全屏
					if (document.exitFullscreen) document.exitFullscreen();
					else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
					else if (document.mozCancelFullScreen) document.mozCancelFullScreen();
					else if (document.msExitFullscreen) document.msExitFullscreen();
				} else {
					// 进入全屏
					if (element.requestFullscreen) element.requestFullscreen();
					else if (element.webkitRequestFullscreen) element.webkitRequestFullscreen();
					else if (element.mozRequestFullScreen) element.mozRequestFullScreen();
					else if (element.msRequestFullscreen) element.msRequestFullscreen();
				}
			}

			// 关闭模态框
			closeModalBtn.addEventListener('click', () => {
				screenModal.classList.add('hidden');
				document.body.style.overflow = 'auto';
				// 退出原生全屏模式
				if (document.fullscreenElement) toggleNativeFullscreen();
			});

			// ESC键监听（双重保障）closeModal
			document.addEventListener('keydown', (e) => {
				if (e.key === 'Escape') {
					screenModal.classList.add('hidden');
					document.body.style.overflow = 'auto';

					// 同步退出原生全屏
					if (document.fullscreenElement) toggleNativeFullscreen();
				}
			});

			// 移动端触摸优化
			let touchStartTime = 0;
			let touchCount = 0;

			// 双击退出全屏（移动端）
			fullScreenView.addEventListener('touchstart', (e) => {
				e.preventDefault(); // 防止默认缩放行为
				touchCount++;
				touchStartTime = Date.now();

				setTimeout(() => {
					if (touchCount === 2) {
						// 双击退出全屏
						screenModal.classList.add('hidden');
						document.body.style.overflow = 'auto';
						if (document.fullscreenElement) toggleNativeFullscreen();
					}
					touchCount = 0;
				}, 300);
			});

			// 防止图片被意外缩放
			fullScreenView.addEventListener('touchmove', (e) => {
				if (e.touches.length > 1) {
					e.preventDefault();
				}
			});

			// 防止长按菜单
			fullScreenView.addEventListener('contextmenu', (e) => {
				e.preventDefault();
			});

			// 全屏状态变化监听（兼容不同浏览器）
			document.addEventListener('fullscreenchange', handleFullscreenChange);
			document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
			document.addEventListener('mozfullscreenchange', handleFullscreenChange);
			document.addEventListener('MSFullscreenChange', handleFullscreenChange);

			function handleFullscreenChange() {
				if (!document.fullscreenElement &&
					!document.webkitFullscreenElement &&
					!document.mozFullScreenElement &&
					!document.msFullscreenElement) {
					// 退出全屏时关闭模态框并恢复页面滚动
					screenModal.classList.add('hidden');
					document.body.style.overflow = 'auto';
				}
			}

			// 更新监控显示
			function updateMonitorDisplay(data) {
				// 更新CPU
				document.getElementById('cpu-percent').textContent = data.cpu_percent.toFixed(1) + '%';
				document.getElementById('cpu-bar').style.width = data.cpu_percent + '%';

				// 更新内存
				document.getElementById('memory-percent').textContent = data.memory.percent.toFixed(1) + '%';
				document.getElementById('memory-bar').style.width = data.memory.percent + '%';
				document.getElementById('memory-used').textContent = (data.memory.used / (1024**3)).toFixed(2) + ' GB';
				document.getElementById('memory-total').textContent = (data.memory.total / (1024**3)).toFixed(2) + ' GB';

				// 更新网络速度
				document.getElementById('upload-speed').textContent = formatBytes(data.network.upload_speed) + '/s';
				document.getElementById('download-speed').textContent = formatBytes(data.network.download_speed) + '/s';
			}

			// 格式化字节数
			function formatBytes(bytes) {
				if (bytes === 0 || bytes === null || bytes === undefined) return '0 B';
				const k = 1024;
				const sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB'];
				const i = Math.floor(Math.log(bytes) / Math.log(k));
				// 确保索引不超出数组范围
				const sizeIndex = Math.min(i, sizes.length - 1);
				return parseFloat((bytes / Math.pow(k, sizeIndex)).toFixed(2)) + ' ' + sizes[sizeIndex];
			}

			// 刷新磁盘信息
			async function refreshDiskInfo() {
				const diskContainer = document.getElementById('disk-info');
				const refreshBtn = document.querySelector('[onclick="refreshDiskInfo()"]');
				
				try {
					// 显示加载状态
					if (refreshBtn) {
						refreshBtn.disabled = true;
						refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
					}
					diskContainer.innerHTML = '<div class="loading text-center py-4"><i class="fas fa-spinner fa-spin"></i> 加载中...</div>';
					
					const response = await fetch(`${baseUrl}/api/system/info`);
					if (!response.ok) {
						throw new Error(`HTTP ${response.status}: ${response.statusText}`);
					}
					
					const data = await response.json();
					diskContainer.innerHTML = '';

					if (data.disk && data.disk.length > 0) {
						data.disk.forEach(disk => {
							const diskElement = document.createElement('div');
							diskElement.className = 'mb-3 p-3 bg-white rounded-lg border';
							diskElement.innerHTML = `
								<div class="flex justify-between items-center mb-2">
									<span class="text-sm font-semibold text-gray-700 dark:text-gray-300">${disk.device}</span>
									<span class="text-sm font-bold text-orange-600">${disk.percent.toFixed(1)}%</span>
								</div>
								<div class="w-full bg-orange-200 rounded-full h-3 mb-2">
									<div class="bg-orange-600 h-3 rounded-full transition-all duration-300" style="width: ${disk.percent}%"></div>
								</div>
								<div class="text-xs text-gray-600 dark:text-gray-400 flex justify-between">
									<span>已用: ${formatBytes(disk.used)}</span>
									<span>总计: ${formatBytes(disk.total)}</span>
								</div>
							`;
							diskContainer.appendChild(diskElement);
						});
					} else {
						diskContainer.innerHTML = '<div class="text-center py-4 text-gray-500 dark:text-gray-400">未找到磁盘信息</div>';
					}
				} catch (error) {
					console.error('获取磁盘信息失败:', error);
					diskContainer.innerHTML = `
						<div class="error-state text-center py-4">
							<i class="fas fa-exclamation-triangle text-red-500 mb-2"></i>
							<div class="text-red-600">获取磁盘信息失败</div>
							<div class="text-sm text-gray-500 dark:text-gray-400 mt-1">${error.message}</div>
							<button onclick="refreshDiskInfo()" class="mt-2 px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">
								重试
							</button>
						</div>
					`;
					showToast('获取磁盘信息失败: ' + error.message, true);
				} finally {
					// 恢复刷新按钮
					if (refreshBtn) {
						refreshBtn.disabled = false;
						refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
					}
				}
			}

			// 刷新进程列表
			async function refreshProcesses() {
				const refreshBtn = document.querySelector('[onclick="refreshProcesses()"]');
				const processTable = document.getElementById('process-table');
				
				try {
					// 显示加载状态
					if (refreshBtn) {
						refreshBtn.disabled = true;
						refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 刷新中';
					}
					
					if (processTable) {
						processTable.innerHTML = `
							<tr>
								<td colspan="6" class="text-center py-8">
									<i class="fas fa-spinner fa-spin text-blue-500 mb-2"></i>
									<div>正在加载进程列表...</div>
								</td>
							</tr>
						`;
					}
					
					const response = await fetch(`${baseUrl}/api/system/processes`);
					if (!response.ok) {
						throw new Error(`HTTP ${response.status}: ${response.statusText}`);
					}
					
					const data = await response.json();
					
					if (data.processes && Array.isArray(data.processes)) {
					allProcesses = data.processes;
					// 初始化时只显示运行中的进程
					filteredProcesses = allProcesses.filter(process => process.status === 'running');
					displayProcesses(filteredProcesses);
					showToast(`成功加载 ${filteredProcesses.length} 个运行中的进程`);
					} else {
						throw new Error('服务器返回的数据格式不正确');
					}
				} catch (error) {
					console.error('获取进程列表失败:', error);
					
					if (processTable) {
						processTable.innerHTML = `
							<tr>
								<td colspan="6" class="text-center py-8">
									<div class="error-state">
										<i class="fas fa-exclamation-triangle text-red-500 mb-2"></i>
										<div class="text-red-600 mb-2">获取进程列表失败</div>
										<div class="text-sm text-gray-500 dark:text-gray-400 mb-3">${error.message}</div>
										<button onclick="refreshProcesses()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
											重试
										</button>
									</div>
								</td>
							</tr>
						`;
					}
					showToast('获取进程列表失败: ' + error.message, true);
				} finally {
					// 恢复刷新按钮
					if (refreshBtn) {
						refreshBtn.disabled = false;
						refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> 刷新进程';
					}
				}
			}

			// 显示进程列表
			function displayProcesses(processes) {
				const tbody = document.getElementById('process-list');
				tbody.innerHTML = '';

				// 只显示运行中的进程
			const runningProcesses = processes.filter(process => process.status === 'running');
			
			runningProcesses.slice(0, 50).forEach(process => {
				const row = document.createElement('tr');
				row.className = 'border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors';
				row.innerHTML = `
					<td class="p-2 sm:p-4 font-mono text-xs sm:text-sm max-w-32 sm:max-w-xs break-words" title="${process.name}">${process.name}</td>
					<td class="p-2 sm:p-4 font-semibold text-xs sm:text-sm">${process.cpu_percent}%</td>
					<td class="p-2 sm:p-4 font-semibold text-xs sm:text-sm">${process.memory_percent.toFixed(2)}%</td>
					<td class="p-2 sm:p-4">
						<button onclick="killProcess(${process.pid}, '${process.name}')" 
							class="kill-btn bg-gradient-to-r from-red-500 to-red-600 text-white px-2 py-1 sm:px-3 sm:py-1.5 rounded text-xs sm:text-sm font-medium hover:from-red-600 hover:to-red-700 active:scale-95 transition-all duration-200 shadow-sm hover:shadow-md">
							结束
						</button>
					</td>
				`;
				tbody.appendChild(row);
			});
			}

			// 过滤进程
			function filterProcesses() {
				const searchTerm = document.getElementById('process-search').value.toLowerCase();
				filteredProcesses = allProcesses.filter(process => 
					process.status === 'running' && process.name.toLowerCase().includes(searchTerm)
				);
				displayProcesses(filteredProcesses);
			}

			// 结束进程
			async function killProcess(pid, name) {
				// 使用更友好的确认对话框
				const confirmed = await showConfirmDialog(
					'确认结束进程',
					`确定要结束进程 "${name}" 吗？\n\n⚠️ 此操作不可撤销，可能会导致数据丢失。`,
					'结束进程',
					'取消'
				);
				
				if (!confirmed) {
					return;
				}

				try {
					const response = await fetch(`${baseUrl}/api/system/kill-process`, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({ pid: pid, force: false })
					});

					if (response.ok) {
						const result = await response.json();
						showToast(result.message);
						// 刷新进程列表
						setTimeout(refreshProcesses, 1000);
					} else {
						const error = await response.json();
						showToast(error.detail, true);
					}
				} catch (error) {
					console.error('结束进程失败:', error);
					showToast('结束进程失败', true);
			}
		}
		
		// 主题切换功能
		let isDarkMode = localStorage.getItem('darkMode') === 'true';
		
		function toggleTheme() {
			isDarkMode = !isDarkMode;
			localStorage.setItem('darkMode', isDarkMode);
			applyTheme();
		}
		
		function applyTheme() {
			const body = document.body;
			const themeIcon = document.getElementById('theme-icon');
			
			if (isDarkMode) {
				body.classList.add('dark');
				body.style.backgroundColor = '#1f2937';
				body.style.color = '#f9fafb';
				// 更新主题图标为太阳图标
				themeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />';
			} else {
				body.classList.remove('dark');
				body.style.backgroundColor = '#f3f4f6';
				body.style.color = '#111827';
				// 更新主题图标为月亮图标
				themeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />';
			}
			
			// 更新所有卡片和元素的主题
			updateElementsTheme();
		}
		
		function updateElementsTheme() {
			const cards = document.querySelectorAll('.card, .bg-white');
			const inputs = document.querySelectorAll('input, textarea');
			const buttons = document.querySelectorAll('button');
			
			cards.forEach(card => {
				if (isDarkMode) {
					card.style.backgroundColor = '#374151';
					card.style.color = '#f9fafb';
				} else {
					card.style.backgroundColor = '#ffffff';
					card.style.color = '#111827';
				}
			});
			
			inputs.forEach(input => {
				if (isDarkMode) {
					input.style.backgroundColor = '#4b5563';
					input.style.color = '#f9fafb';
					input.style.borderColor = '#6b7280';
				} else {
					input.style.backgroundColor = '#ffffff';
					input.style.color = '#111827';
					input.style.borderColor = '#d1d5db';
				}
			});
		}
		
		// 文件管理功能
		let currentPath = '';
		let clipboard = { files: [], operation: '' }; // copy 或 cut
		
		// 初始化文件管理
		async function initFileManager() {
			try {
				const response = await fetch(`${baseUrl}/api/files/drives`);
				const data = await response.json();
				
				if (data.success && data.drives.length > 0) {
					// 默认显示第一个驱动器
					currentPath = data.drives[0].path;
					loadFileList(currentPath);
				} else {
					showToast('无法获取驱动器列表', true);
				}
			} catch (error) {
				console.error('初始化文件管理失败:', error);
				showToast('初始化文件管理失败', true);
			}
		}
		
		// 加载文件列表
		async function loadFileList(path) {
			try {
				const fileList = document.getElementById('file-list');
				fileList.innerHTML = '<div class="p-4 text-center text-gray-500 dark:text-gray-400"><div class="animate-spin w-6 h-6 border-2 border-blue-500 dark:border-blue-400 border-t-transparent rounded-full mx-auto mb-2"></div>加载中...</div>';
				
				// 确保路径格式正确
				const normalizedPath = path.replace(/[\/]/g, '\\');
				
				const response = await fetch(`${baseUrl}/api/files/list?path=${encodeURIComponent(normalizedPath)}`);
				const data = await response.json();
				
				if (data.success) {
					currentPath = data.path;
					// 确保当前路径显示格式正确
					const displayPath = currentPath.endsWith('\\') && currentPath.length > 3 ? 
						currentPath.slice(0, -1) : currentPath;
					document.getElementById('current-path').textContent = displayPath;
					displayFileList(data.items);
				} else {
					showToast('加载文件列表失败: ' + (data.message || '未知错误'), true);
				}
			} catch (error) {
				console.error('加载文件列表失败:', error);
				showToast('加载文件列表失败: ' + error.message, true);
			}
		}
		
		// 显示文件列表
		function displayFileList(items) {
			const fileList = document.getElementById('file-list');
			
			if (items.length === 0) {
				fileList.innerHTML = '<div class="p-4 text-center text-gray-500 dark:text-gray-400">此目录为空</div>';
				return;
			}
			
			fileList.innerHTML = items.map(item => {
				const icon = getFileIcon(item);
				const size = item.is_directory ? '' : formatFileSize(item.size);
				const modified = new Date(item.modified).toLocaleString('zh-CN');
				
				// 安全地转义路径中的特殊字符
				const escapedPath = item.path.replace(/\\/g, '\\\\').replace(/'/g, "\\'")
				const escapedName = item.name.replace(/'/g, "\\'")
				
				return `
					<div class="file-item p-3 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer flex items-center justify-between" 
					 onclick="${item.is_directory ? `loadFileList('${escapedPath}')` : `handleFileClick('${escapedPath}', '${item.type}')`}">
					<div class="flex items-center flex-1 min-w-0">
						<div class="mr-3 text-2xl">${icon}</div>
						<div class="flex-1 min-w-0">
							<div class="font-medium text-sm truncate text-gray-900 dark:text-gray-100" title="${item.name}">${item.name}</div>
							<div class="text-xs text-gray-500 dark:text-gray-400">${size} ${modified}</div>
						</div>
					</div>
					<div class="flex items-center gap-1">
						<button onclick="event.stopPropagation(); showFileMenu('${escapedPath}', '${escapedName}', ${item.is_directory})" 
							class="p-1 hover:bg-gray-200 dark:hover:bg-gray-600 rounded text-gray-600 dark:text-gray-300">
							<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
								<path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
							</svg>
						</button>
					</div>
				</div>
				`;
			}).join('');
			
			// 异步加载exe和lnk文件的真实图标
			loadRealIcons();
		}
		
		// 异步加载真实图标
		async function loadRealIcons() {
			const placeholders = document.querySelectorAll('.file-icon-placeholder');
			
			for (const placeholder of placeholders) {
				const path = placeholder.getAttribute('data-path');
				const type = placeholder.getAttribute('data-type');
				
				try {
					const response = await fetch(`${baseUrl}/api/files/icon?path=${encodeURIComponent(path)}`);
					const data = await response.json();
					
					if (data.success) {
						if (data.icon_type === 'base64') {
							// 显示真实图标
							placeholder.innerHTML = `<img src="${data.icon}" alt="图标" class="w-6 h-6 object-contain" onerror="this.style.display='none'; this.nextSibling.style.display='inline';"><span style="display:none;">${type === 'exe' ? '⚙️' : '🔗'}</span>`;
						} else {
							// 使用emoji图标
							placeholder.textContent = data.icon;
						}
						placeholder.classList.remove('file-icon-placeholder');
					} else {
						// 保持默认图标
						placeholder.textContent = type === 'exe' ? '⚙️' : '🔗';
						placeholder.classList.remove('file-icon-placeholder');
					}
				} catch (error) {
					console.warn('获取文件图标失败:', error);
					// 保持默认图标
					placeholder.textContent = type === 'exe' ? '⚙️' : '🔗';
					placeholder.classList.remove('file-icon-placeholder');
				}
			}
		}
		
		// 获取文件图标
		function getFileIcon(item) {
			if (item.is_directory) return '📁';
			
			// 检查是否为exe或lnk文件，需要获取真实图标
			const fileExt = item.name.toLowerCase().split('.').pop();
			if (fileExt === 'exe' || fileExt === 'lnk') {
				// 返回一个占位符，稍后异步加载真实图标
				const defaultIcon = fileExt === 'exe' ? '⚙️' : '🔗';
				return `<div class="file-icon-placeholder" data-path="${item.path}" data-type="${fileExt}">${defaultIcon}</div>`;
			}
			
			switch (item.type) {
				case 'image': return '🖼️';
				case 'video': return '🎬';
				case 'audio': return '🎵';
				case 'text': return '📄';
				case 'executable': return '⚙️';
				default: return '📄';
			}
		}
		
		// 格式化文件大小
		function formatFileSize(bytes) {
			if (bytes === 0) return '0 B';
			const k = 1024;
			const sizes = ['B', 'KB', 'MB', 'GB'];
			const i = Math.floor(Math.log(bytes) / Math.log(k));
			return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
		}
		
		// 处理文件点击
		async function handleFileClick(path, type) {
			// 检查文件扩展名
			const fileExt = path.toLowerCase().split('.').pop();
			
			// 可执行文件直接执行
			if (fileExt === 'exe' || fileExt === 'lnk' || type === 'executable') {
				executeFile(path);
				return;
			}
			
			// 图片文件直接打开图片查看器
			if (type === 'image') {
				openImageViewer(path);
				return;
			}
			
			// 视频文件直接打开视频播放器
			if (type === 'video') {
				openVideoPlayer(path);
				return;
			}
			
			// 音频文件直接打开音频播放器
			if (type === 'audio') {
				openAudioPlayer(path);
				return;
			}
			
			// 其他文件尝试作为文本文件打开
			try {
				const response = await fetch(`${baseUrl}/api/files/open?path=${encodeURIComponent(path)}`);
				const data = await response.json();
				
				if (data.success) {
					// 成功打开文本文件
					openTextEditor(path, data.content, data.encoding);
				} else {
					// 打开失败，根据类型处理
					handleFileOpenError(path, type, data.detail || '打开失败');
				}
			} catch (error) {
				// 网络错误或其他错误
				handleFileOpenError(path, type, '网络错误');
			}
		}
		
		// 处理文件打开错误
		function handleFileOpenError(path, type, errorMsg) {
			if (errorMsg.includes('二进制文件无法打开')) {
				showToast('二进制文件无法打开，请下载后使用相应程序打开', true);
				// 可以选择自动下载
				showConfirmDialog('确认下载', '是否下载该文件？', () => {
				downloadFile(path);
			});
			} else if (errorMsg.includes('文件过大')) {
				showToast('文件过大，无法在线打开，请下载后查看', true);
				showConfirmDialog('确认下载', '是否下载该文件？', () => {
				downloadFile(path);
			});
			} else {
				// 根据文件类型处理
				switch (type) {
					case 'image':
						openImageViewer(path);
						break;
					case 'video':
						openVideoPlayer(path);
						break;
					case 'audio':
						openAudioPlayer(path);
						break;
					default:
						showToast(`无法打开文件: ${errorMsg}`, true);
						showConfirmDialog('确认下载', '是否下载该文件？', () => {
					downloadFile(path);
				});
						break;
				}
			}
		}
		
		// 刷新文件列表
		function refreshFileList() {
			loadFileList(currentPath);
		}
		
		// 返回上级目录
		function goToParentDirectory() {
			const parentPath = currentPath.split(/[\\/]/).slice(0, -1).join('\\');
			if (parentPath && parentPath !== currentPath) {
				loadFileList(parentPath);
			}
		}
		
		// 执行文件
		async function executeFile(path) {
			try {
				const response = await fetch(`${baseUrl}/api/files/execute`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ path })
				});
				
				const data = await response.json();
				if (data.success) {
					showToast(data.message);
				} else {
					showToast('执行失败', true);
				}
			} catch (error) {
				showToast('执行失败', true);
			}
		}
		
		// 下载文件
		function downloadFile(path) {
			window.open(`${baseUrl}/api/files/download?path=${encodeURIComponent(path)}`, '_blank');
		}
		
		// 打开文本编辑器
		async function openTextEditor(path, content = null, encoding = null) {
			// 如果已经有内容，直接显示
			if (content !== null) {
				showTextEditor(path, content, encoding);
				return;
			}
			
			// 否则从服务器获取内容
			try {
				const response = await fetch(`${baseUrl}/api/files/content?path=${encodeURIComponent(path)}`);
				const data = await response.json();
				
				if (data.success) {
					showTextEditor(path, data.content);
				} else {
					showToast('无法打开文件', true);
				}
			} catch (error) {
				showToast('打开文件失败', true);
			}
		}
		
		// 显示文本编辑器
		function showTextEditor(path, content, encoding = null) {
			const modal = document.createElement('div');
			modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
			// 安全地转义路径中的特殊字符
			const escapedPath = path.replace(/\\/g, '\\\\').replace(/'/g, "\\'")
			const fileName = path.split(/[\\/]/).pop();
			// 转义内容中的HTML特殊字符
			const escapedContent = content.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
			
			// 编码信息
			const encodingInfo = encoding ? ` (${encoding})` : '';
			
			modal.innerHTML = `
				<div class="bg-white rounded-lg w-full max-w-4xl h-5/6 flex flex-col">
					<div class="flex items-center justify-between p-4 border-b">
						<h3 class="font-semibold truncate">${fileName}${encodingInfo}</h3>
						<div class="flex gap-2">
							<button onclick="saveTextFile('${escapedPath}')" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">保存</button>
							<button onclick="closeModal()" class="px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600">关闭</button>
						</div>
					</div>
					<textarea id="text-editor" class="flex-1 p-4 border-none outline-none resize-none font-mono text-sm">${escapedContent}</textarea>
				</div>
			`;
			
			document.body.appendChild(modal);
			window.currentModal = modal;
		}
		
		// 打开音频播放器
		function openAudioPlayer(path) {
			const modal = document.createElement('div');
			modal.className = 'fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4';
			modal.innerHTML = `
				<div class="relative bg-gray-800 rounded-lg p-6 max-w-md w-full">
					<h3 class="text-white text-lg font-semibold mb-4 truncate">${path.split(/[\\/]/).pop()}</h3>
					<audio controls class="w-full">
						<source src="${baseUrl}/api/files/download?path=${encodeURIComponent(path)}" type="audio/mpeg">
						您的浏览器不支持音频播放。
					</audio>
					<button onclick="closeModal()" 
						 class="absolute top-4 right-4 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-70">
						<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
						</svg>
					</button>
				</div>
			`;
			
			 document.body.appendChild(modal);
			 window.currentModal = modal;
		}
		
		// 保存文本文件
		async function saveTextFile(path) {
			try {
				const content = document.getElementById('text-editor').value;
				const response = await fetch(`${baseUrl}/api/files/content`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ path, content })
				});
				
				const data = await response.json();
				if (data.success) {
					showToast('保存成功');
				} else {
					showToast('保存失败', true);
				}
			} catch (error) {
				showToast('保存失败', true);
			}
		}
		
		// 打开图片查看器
		function openImageViewer(path) {
			const modal = document.createElement('div');
			modal.className = 'fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4';
			modal.innerHTML = `
				<div class="relative max-w-full max-h-full">
					<img src="${baseUrl}/api/files/download?path=${encodeURIComponent(path)}" 
						 class="max-w-full max-h-full object-contain" 
						 alt="${path.split(/[\\/]/).pop()}">
					<button onclick="closeModal()" 
						 class="absolute top-4 right-4 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-70">
						<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
						</svg>
					</button>
				</div>
			`;
			
			document.body.appendChild(modal);
			window.currentModal = modal;
		}
		
		// 打开视频播放器
		function openVideoPlayer(path) {
			const modal = document.createElement('div');
			modal.className = 'fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4';
			modal.innerHTML = `
				<div class="relative w-full max-w-4xl">
					<video controls class="w-full h-auto max-h-full">
						<source src="${baseUrl}/api/files/download?path=${encodeURIComponent(path)}" type="video/mp4">
						您的浏览器不支持视频播放。
					</video>
					<button onclick="closeModal()" 
						 class="absolute top-4 right-4 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-70">
						<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
						</svg>
					</button>
				</div>
			`;
			
			document.body.appendChild(modal);
			window.currentModal = modal;
		}
		
		// 关闭模态框
		function closeModal() {
			if (window.currentModal) {
				document.body.removeChild(window.currentModal);
				window.currentModal = null;
			}
		}
		
		// 显示文件菜单
		function showFileMenu(path, name, isDirectory) {
			const modal = document.createElement('div');
			modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
			
			// 安全地转义路径和名称中的特殊字符
			const escapedPath = path.replace(/\\/g, '\\\\').replace(/'/g, "\\'")
			const escapedName = name.replace(/'/g, "\\'")
			
			// 构建菜单选项
			let menuOptions = `
				<button onclick="renameFile('${escapedPath}', '${escapedName}')" class="w-full text-left p-2 hover:bg-gray-100 rounded">重命名</button>
				<button onclick="copyFile('${escapedPath}')" class="w-full text-left p-2 hover:bg-gray-100 rounded">复制</button>
				<button onclick="cutFile('${escapedPath}')" class="w-full text-left p-2 hover:bg-gray-100 rounded">剪切</button>`;
			
			// 如果不是目录，添加下载选项
			if (!isDirectory) {
				menuOptions += `<button onclick="downloadFile('${escapedPath}')" class="w-full text-left p-2 hover:bg-blue-100 text-blue-600 rounded">下载</button>`;
			}
			
			menuOptions += `
				<button onclick="deleteFile('${escapedPath}', '${escapedName}')" class="w-full text-left p-2 hover:bg-red-100 text-red-600 rounded">删除</button>
				<button onclick="closeModal()" class="w-full text-left p-2 hover:bg-gray-100 rounded">取消</button>`;
			
			modal.innerHTML = `
				<div class="bg-white rounded-lg p-4 w-full max-w-sm">
					<h3 class="font-semibold mb-4 truncate">${name}</h3>
					<div class="space-y-2">
						${menuOptions}
					</div>
				</div>
			`;
			
			document.body.appendChild(modal);
			window.currentModal = modal;
		}
		
		// 重命名文件
		async function renameFile(path, oldName) {
			closeModal();
			const newName = prompt('请输入新名称:', oldName);
			if (!newName || newName === oldName) return;
			
			try {
				const response = await fetch(`${baseUrl}/api/files/operation`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ path, new_name: newName, operation: 'rename' })
				});
				
				const data = await response.json();
				if (data.success) {
					showToast('重命名成功');
					refreshFileList();
				} else {
					showToast('重命名失败', true);
				}
			} catch (error) {
				showToast('重命名失败', true);
			}
		}
		
		// 复制文件
		function copyFile(path) {
			clipboard = { files: [path], operation: 'copy' };
			document.getElementById('paste-btn').classList.remove('hidden');
			showToast('已复制到剪贴板');
			closeModal();
		}
		
		// 剪切文件
		function cutFile(path) {
			clipboard = { files: [path], operation: 'cut' };
			document.getElementById('paste-btn').classList.remove('hidden');
			showToast('已剪切到剪贴板');
			closeModal();
		}
		
		// 粘贴文件
		async function pasteFiles() {
			if (clipboard.files.length === 0) return;
			
			try {
				for (const filePath of clipboard.files) {
					const fileName = filePath.split(/[\\/]/).pop();
					// 确保路径格式正确，避免双斜杠问题
					let normalizedCurrentPath = currentPath.replace(/[\/]/g, '\\');
					if (!normalizedCurrentPath.endsWith('\\')) {
						normalizedCurrentPath += '\\';
					}
					const targetPath = normalizedCurrentPath + fileName;
					
					const response = await fetch(`${baseUrl}/api/files/operation`, {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ 
							path: filePath, 
							target_path: targetPath, 
							operation: clipboard.operation === 'cut' ? 'move' : 'copy' 
						})
					});
					
					const data = await response.json();
					if (!data.success) {
						throw new Error(data.message || '操作失败');
					}
				}
				
				showToast('粘贴成功');
				clipboard = { files: [], operation: '' };
				document.getElementById('paste-btn').classList.add('hidden');
				refreshFileList();
			} catch (error) {
				showToast('粘贴失败: ' + error.message, true);
			}
		}
		
		// 删除文件
		async function deleteFile(path, name) {
			closeModal();
			showConfirmDialog('确认删除', `确定要删除 "${name}" 吗？此操作不可撤销。`, async () => {
				await performDelete(path, name);
			});
		}
		
		// 执行删除操作
		async function performDelete(path, name) {
			
			try {
				const response = await fetch(`${baseUrl}/api/files/operation`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ path, operation: 'delete' })
				});
				
				const data = await response.json();
				if (data.success) {
					showToast('删除成功');
					refreshFileList();
				} else {
					showToast('删除失败', true);
				}
			} catch (error) {
				showToast('删除失败', true);
			}
		}
		
		// 显示路径导航对话框
		function showPathNavigation() {
			const modal = document.createElement('div');
			modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
			modal.innerHTML = `
				<div class="bg-white rounded-lg p-6 w-full max-w-md">
					<h3 class="font-semibold mb-4">路径导航</h3>
					<div class="mb-4">
						<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">输入路径:</label>
						<input type="text" id="path-input" value="${currentPath}" 
							class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
					</div>
					<div class="mb-4">
						<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">快速导航:</label>
						<div class="grid grid-cols-2 gap-2">
							<button onclick="navigateToPath('C:\\\\')" class="p-2 text-left bg-gray-100 hover:bg-gray-200 rounded text-sm">C盘根目录</button>
							<button onclick="navigateToPath('D:\\\\')" class="p-2 text-left bg-gray-100 hover:bg-gray-200 rounded text-sm">D盘根目录</button>
							<button onclick="navigateToPath('C:\\\\Users')" class="p-2 text-left bg-gray-100 hover:bg-gray-200 rounded text-sm">用户目录</button>
							<button onclick="navigateToPath('C:\\\\Windows')" class="p-2 text-left bg-gray-100 hover:bg-gray-200 rounded text-sm">Windows目录</button>
						</div>
					</div>
					<div class="flex gap-2 justify-end">
						<button onclick="closeModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">取消</button>
						<button onclick="navigateToInputPath()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">前往</button>
					</div>
				</div>
			`;
			
			document.body.appendChild(modal);
			window.currentModal = modal;
			
			// 聚焦到输入框并选中文本
			setTimeout(() => {
				const input = document.getElementById('path-input');
				input.focus();
				input.select();
			}, 100);
			
			// 回车键快速导航
			document.getElementById('path-input').addEventListener('keypress', function(e) {
				if (e.key === 'Enter') {
					navigateToInputPath();
				}
			});
		}
		
		// 导航到指定路径
		function navigateToPath(path) {
			closeModal();
			currentPath = path;
			loadFileList(path);
		}
		
		// 导航到输入框中的路径
		function navigateToInputPath() {
			const input = document.getElementById('path-input');
			const path = input.value.trim();
			if (path) {
				navigateToPath(path);
			}
		}
		
		// 显示新建对话框
		function showCreateDialog() {
			const modal = document.createElement('div');
			modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
			modal.innerHTML = `
				<div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md">
					<h3 class="font-semibold mb-4 text-gray-900 dark:text-gray-100">新建文件/文件夹</h3>
					<div class="mb-4">
						<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">类型:</label>
						<div class="flex gap-2 mb-3">
							<button id="create-file-btn" onclick="selectCreateType('file')" class="px-3 py-1 bg-blue-500 dark:bg-blue-600 text-white rounded text-sm hover:bg-blue-600 dark:hover:bg-blue-700 transition-colors">文件</button>
							<button id="create-folder-btn" onclick="selectCreateType('folder')" class="px-3 py-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded text-sm hover:bg-gray-400 dark:hover:bg-gray-500 transition-colors">文件夹</button>
						</div>
					</div>
					<div class="mb-4">
						<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">名称:</label>
						<input type="text" id="create-name-input" placeholder="请输入名称" 
							class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
					</div>
					<div class="flex gap-2 justify-end">
						<button onclick="closeModal()" class="px-4 py-2 bg-gray-500 dark:bg-gray-600 text-white rounded hover:bg-gray-600 dark:hover:bg-gray-700 transition-colors">取消</button>
						<button onclick="createFileOrFolder()" class="px-4 py-2 bg-blue-500 dark:bg-blue-600 text-white rounded hover:bg-blue-600 dark:hover:bg-blue-700 transition-colors">创建</button>
					</div>
				</div>
			`;
			
			document.body.appendChild(modal);
			window.currentModal = modal;
			window.createType = 'file';
			
			// 聚焦到输入框
			setTimeout(() => {
				document.getElementById('create-name-input').focus();
			}, 100);
		}
		
		// 选择创建类型
		function selectCreateType(type) {
			window.createType = type;
			const fileBtn = document.getElementById('create-file-btn');
			const folderBtn = document.getElementById('create-folder-btn');
			
			if (type === 'file') {
				fileBtn.className = 'px-3 py-1 bg-blue-500 dark:bg-blue-600 text-white rounded text-sm hover:bg-blue-600 dark:hover:bg-blue-700 transition-colors';
				folderBtn.className = 'px-3 py-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded text-sm hover:bg-gray-400 dark:hover:bg-gray-500 transition-colors';
			} else {
				fileBtn.className = 'px-3 py-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded text-sm hover:bg-gray-400 dark:hover:bg-gray-500 transition-colors';
				folderBtn.className = 'px-3 py-1 bg-blue-500 dark:bg-blue-600 text-white rounded text-sm hover:bg-blue-600 dark:hover:bg-blue-700 transition-colors';
			}
		}
		
		// 创建文件或文件夹
		async function createFileOrFolder() {
			const name = document.getElementById('create-name-input').value.trim();
			if (!name) {
				showToast('请输入名称', true);
				return;
			}
			
			// 确保路径格式正确
				let normalizedCurrentPath = currentPath.replace(/[\/]/g, '\\');
				if (!normalizedCurrentPath.endsWith('\\')) {
					normalizedCurrentPath += '\\';
				}
				const path = normalizedCurrentPath + name;
			closeModal();
			
			try {
				if (window.createType === 'file') {
					// 创建空文件
					const response = await fetch(`${baseUrl}/api/files/content`, {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ path, content: '' })
					});
					
					const data = await response.json();
					if (data.success) {
						showToast('文件创建成功');
						refreshFileList();
					} else {
						showToast('文件创建失败: ' + data.message, true);
					}
				} else {
					// 创建文件夹 - 使用mkdir命令
					const response = await fetch(`${baseUrl}/api/execute`, {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ command: `mkdir "${path}"`, powershell: true })
					});
					
					const data = await response.json();
					if (data.success) {
						showToast('文件夹创建成功');
						refreshFileList();
					} else {
						showToast('文件夹创建失败', true);
					}
				}
			} catch (error) {
				showToast('创建失败', true);
			}
		}
		
		// 显示上传对话框
		function showUploadDialog() {
			const modal = document.createElement('div');
			modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
			modal.innerHTML = `
				<div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md">
					<h3 class="font-semibold mb-4 text-gray-900 dark:text-gray-100">上传文件</h3>
					<div class="mb-4">
						<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">选择文件:</label>
						<input type="file" id="upload-input" multiple 
							class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
						<div class="text-xs text-gray-500 dark:text-gray-400 mt-1">支持多文件上传</div>
					</div>
					<div id="upload-progress" class="mb-4 hidden">
						<div class="text-sm text-gray-600 dark:text-gray-400 mb-1">上传进度:</div>
						<div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
							<div id="upload-progress-bar" class="bg-blue-600 dark:bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
						</div>
						<div id="upload-status" class="text-xs text-gray-500 dark:text-gray-400 mt-1"></div>
					</div>
					<div class="flex gap-2 justify-end">
						<button onclick="closeModal()" class="px-4 py-2 bg-gray-500 dark:bg-gray-600 text-white rounded hover:bg-gray-600 dark:hover:bg-gray-700 transition-colors">取消</button>
						<button onclick="uploadFiles()" class="px-4 py-2 bg-blue-500 dark:bg-blue-600 text-white rounded hover:bg-blue-600 dark:hover:bg-blue-700 transition-colors">上传</button>
					</div>
				</div>
			`;
			
			document.body.appendChild(modal);
			window.currentModal = modal;
		}
		
		// 上传文件
		async function uploadFiles() {
			const input = document.getElementById('upload-input');
			const files = input.files;
			
			if (files.length === 0) {
				showToast('请选择文件', true);
				return;
			}
			
			const progressDiv = document.getElementById('upload-progress');
			const progressBar = document.getElementById('upload-progress-bar');
			const statusDiv = document.getElementById('upload-status');
			
			progressDiv.classList.remove('hidden');
			
			let successCount = 0;
			let failCount = 0;
			
			try {
				for (let i = 0; i < files.length; i++) {
					const file = files[i];
					const formData = new FormData();
					formData.append('file', file);
					formData.append('path', currentPath);
					
					statusDiv.textContent = `上传 ${file.name} (${i + 1}/${files.length})`;
					
					try {
						// 调用上传API
						const response = await fetch(`${baseUrl}/api/files/upload`, {
							method: 'POST',
							body: formData
						});
						
						if (response.ok) {
								const result = await response.json();
								successCount++;
								console.log(`文件上传成功: ${result.filename}`);
							} else {
								const error = await response.json();
								failCount++;
								console.error(`文件上传失败: ${file.name} - ${error.detail}`);
							}
						} catch (uploadError) {
							failCount++;
							console.error(`文件上传异常: ${file.name} - ${uploadError.message}`);
						}
					
					// 更新进度条
					const progress = ((i + 1) / files.length) * 100;
					progressBar.style.width = progress + '%';
				}
				
				// 显示上传结果
				if (failCount === 0) {
					showToast(`成功上传 ${successCount} 个文件`);
				} else if (successCount === 0) {
					showToast(`上传失败，${failCount} 个文件上传失败`, true);
				} else {
					showToast(`上传完成：成功 ${successCount} 个，失败 ${failCount} 个`, true);
				}
				
				// 刷新文件列表
				await loadFileList(currentPath);
				closeModal();
				
			} catch (error) {
				showToast('上传过程中发生错误', true);
				console.error(`上传过程异常: ${error.message}`);
			}
		}
		
		// 通用Dialog函数
		function showDialog(title, message, onConfirm = null) {
			const modal = document.createElement('div');
			modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
			modal.innerHTML = `
				<div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md">
					<h3 class="font-semibold mb-4 text-gray-900 dark:text-gray-100">${title}</h3>
					<p class="text-gray-700 dark:text-gray-300 mb-6">${message}</p>
					<div class="flex gap-2 justify-end">
						${onConfirm ? '<button onclick="closeDialog(); window.dialogConfirmCallback && window.dialogConfirmCallback()" class="px-4 py-2 bg-blue-500 dark:bg-blue-600 text-white rounded hover:bg-blue-600 dark:hover:bg-blue-700 transition-colors mr-2">确定</button>' : ''}
						<button onclick="closeDialog()" class="px-4 py-2 bg-gray-500 dark:bg-gray-600 text-white rounded hover:bg-gray-600 dark:hover:bg-gray-700 transition-colors">${onConfirm ? '取消' : '确定'}</button>
					</div>
				</div>
			`;
			document.body.appendChild(modal);
			window.currentDialog = modal;
			if (onConfirm) {
				window.dialogConfirmCallback = onConfirm;
			}
		}

		function closeDialog() {
			if (window.currentDialog) {
				document.body.removeChild(window.currentDialog);
				window.currentDialog = null;
				window.dialogConfirmCallback = null;
			}
		}

		function showConfirmDialog(title, message, onConfirm) {
			showDialog(title, message, onConfirm);
		}

		// 页面加载时初始化主题
		document.addEventListener('DOMContentLoaded', function() {
			applyTheme();
		});

	</script>
</body>
</html>